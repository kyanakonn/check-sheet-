<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>簡易スケジューラー</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    max-width: 700px;
    margin: auto;
    padding: 1em;
    background: #f0f4f8;
  }
  h1 {
    text-align: center;
    color: #334155;
  }
  #container {
    display: flex;
    flex-direction: column;
    gap: 1em;
  }
  @media (min-width: 768px) {
    #container {
      flex-direction: row;
    }
  }
  #items, #timeline {
    border: 1px solid #ccc;
    padding: 0.5em;
    background: white;
  }
  #items {
    flex: 1;
    max-height: 600px;
    overflow-y: auto;
  }
  #timeline {
    flex: 2;
    max-height: 600px;
    overflow-y: auto;
    position: relative;
  }
  .time-slot {
    border-bottom: 1px solid #ddd;
    height: 40px;
    line-height: 40px;
    padding-left: 8px;
    font-size: 0.9em;
    color: #666;
    position: relative;
  }
  .scheduled-block {
    position: absolute;
    left: 100px;
    right: 10px;
    color: white;
    border-radius: 4px;
    padding: 4px 8px;
    box-sizing: border-box;
    cursor: pointer;
    user-select: none;
    font-size: 0.9em;
  }
  .controls button {
    margin: 2px;
    padding: 2px 6px;
    font-size: 0.75em;
  }
  .item-block {
    background: #2563eb;
    color: white;
    padding: 0.5em;
    margin: 0.3em 0;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
  }
</style>
</head>
<body>
<h1>簡易スケジューラー</h1>
<div id="container">
  <div id="items">
    <h2>項目一覧</h2>
    <div id="itemList"></div>
    <input type="text" id="newItemInput" placeholder="新しい項目を追加" />
    <button id="addItemBtn">追加</button>
    <hr />
    <button onclick="saveTemplate()">テンプレ保存</button>
    <button onclick="loadTemplate()">テンプレ読込</button>
    <button onclick="showHistory()">履歴表示</button>
    <button onclick="showSummary()">週グラフ</button>
  </div>
  <div id="timeline">
    <div id="selectedItem">※ 左の項目をクリックして選択してください</div>
    <div id="timeSlots"></div>
  </div>
</div>
<div id="modal" style="display:none; position:fixed; top:10%; left:10%; right:10%; bottom:10%; background:white; padding:1em; border:2px solid #333; overflow:auto; z-index:9999">
  <button onclick="document.getElementById('modal').style.display='none'">閉じる</button>
  <div id="modalContent"></div>
</div>
<script>
  const TIME_START_HOUR = 8;
  const TIME_END_HOUR = 23;
  const SLOT_HEIGHT_PX = 40;
  let items = JSON.parse(localStorage.getItem("scheduler_items") || "[]");
  let schedule = JSON.parse(localStorage.getItem("scheduler_schedule") || "[]");
  const today = new Date().toISOString().split("T")[0];
  let selectedItem = null;
  const timeSlotsEl = document.getElementById("timeSlots");
  const itemListEl = document.getElementById("itemList");
  const modalContent = document.getElementById("modalContent");

  function generateTimeSlots() {
    const slots = [];
    for(let h = TIME_START_HOUR; h <= TIME_END_HOUR; h++) {
      slots.push(`${String(h).padStart(2,"0")}:00`);
      if(h !== TIME_END_HOUR) slots.push(`${String(h).padStart(2,"0")}:30`);
    }
    return slots;
  }

  function renderItems() {
    itemListEl.innerHTML = "";
    items.forEach((item) => {
      const div = document.createElement("div");
      div.textContent = item;
      div.className = "item-block";
      div.onclick = () => {
        selectedItem = item;
        document.getElementById("selectedItem").textContent = `選択中の項目：${item}`;
      };
      itemListEl.appendChild(div);
    });
  }

  function getColorForIndex(index) {
    const colors = ["#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#6366f1", "#ec4899"];
    return colors[index % colors.length];
  }

  function renderTimeline() {
    const slots = generateTimeSlots();
    timeSlotsEl.innerHTML = "";
    slots.forEach((slot, i) => {
      const div = document.createElement("div");
      div.className = "time-slot";
      div.textContent = slot;
      div.onclick = () => {
        if (!selectedItem) return alert("項目を選んでください");
        if (isOverlapping(slot, 1)) return alert("重複しています");
        schedule.push({item: selectedItem, start: slot, length: 1, date: today});
        saveData();
        renderTimeline();
      };
      timeSlotsEl.appendChild(div);
    });

    schedule.filter(s => s.date === today).forEach((s, i) => {
      const si = slots.indexOf(s.start);
      const ei = si + s.length;
      const end = slots[ei] || "";
      const block = document.createElement("div");
      block.className = "scheduled-block";
      block.style.top = (si * SLOT_HEIGHT_PX) + "px";
      block.style.height = (s.length * SLOT_HEIGHT_PX - 4) + "px";
      block.style.backgroundColor = getColorForIndex(i);
      block.innerHTML = `<strong>${s.item}</strong><br><small>${s.start}〜${end}</small>`;
      const c = document.createElement("div");
      c.className = "controls";
      c.innerHTML = `<button onclick="resize(${i},1)">+30分</button><button onclick="resize(${i},-1)">-30分</button>`;
      block.appendChild(c);
      timeSlotsEl.appendChild(block);
    });
  }

  function resize(i, d) {
    const s = schedule.filter(e => e.date === today)[i];
    if (d > 0 && !isOverlapping(s.start, s.length + d)) s.length += d;
    else if (d < 0) {
      if (s.length === 1) schedule = schedule.filter(e => e !== s);
      else s.length += d;
    }
    saveData();
    renderTimeline();
  }

  function isOverlapping(start, length) {
    const slots = generateTimeSlots();
    const si = slots.indexOf(start);
    const ei = si + length - 1;
    return schedule.some(s => {
      if (s.date !== today) return false;
      const ssi = slots.indexOf(s.start);
      const eei = ssi + s.length - 1;
      return !(ei < ssi || si > eei);
    });
  }

  function saveData() {
    localStorage.setItem("scheduler_items", JSON.stringify(items));
    localStorage.setItem("scheduler_schedule", JSON.stringify(schedule));
  }

  function saveTemplate() {
    localStorage.setItem("scheduler_template", JSON.stringify(schedule.filter(s => s.date === today)));
    alert("テンプレートを保存しました");
  }

  function loadTemplate() {
    const t = localStorage.getItem("scheduler_template");
    if (!t) return alert("テンプレートがありません");
    const data = JSON.parse(t).map(s => ({...s, date: today}));
    schedule = schedule.concat(data);
    saveData();
    renderTimeline();
  }

  function showHistory() {
    const grouped = {};
    schedule.forEach(s => {
      if (!grouped[s.date]) grouped[s.date] = [];
      grouped[s.date].push(`${s.start} ${s.item}（${s.length * 30}分）`);
    });
    let html = "";
    Object.keys(grouped).sort().forEach(d => {
      html += `<h3>${d}</h3><ul>` + grouped[d].map(e => `<li>${e}</li>`).join("") + "</ul>";
    });
    modalContent.innerHTML = html;
    document.getElementById("modal").style.display = "block";
  }

  function showSummary() {
    const summary = {};
    schedule.forEach(s => {
      if (!summary[s.date]) summary[s.date] = 0;
      summary[s.date] += s.length * 30;
    });
    const labels = Object.keys(summary).sort();
    const data = labels.map(d => summary[d]);
    modalContent.innerHTML = `<canvas id='summaryChart'></canvas>`;
    document.getElementById("modal").style.display = "block";
    new Chart(document.getElementById('summaryChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '学習時間（分）',
          data,
          backgroundColor: '#3b82f6'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  document.getElementById("addItemBtn").onclick = () => {
    const val = document.getElementById("newItemInput").value.trim();
    if (!val) return;
    if (items.includes(val)) return alert("重複しています");
    items.push(val);
    saveData();
    renderItems();
  };

  renderItems();
  renderTimeline();
</script>
</body>
</html>
